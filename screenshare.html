<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Global Screen Share</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:black;
  color:white;
  overflow:hidden;
}
video.bg{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  z-index:-2;
}
.overlay{
  position:fixed;
  inset:0;
  background:rgba(5,5,15,.65);
  z-index:-1;
}
.card{
  max-width:420px;
  margin:auto;
  margin-top:8vh;
  background:rgba(255,255,255,.06);
  backdrop-filter:blur(14px);
  padding:20px;
  border-radius:16px;
  border:1px solid rgba(236,72,153,.3);
}
button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  background:linear-gradient(135deg,#ec4899,#6366f1);
  color:white;
  font-size:14px;
  cursor:pointer;
}
video#screen{
  width:100%;
  margin-top:12px;
  border-radius:12px;
  background:black;
}
.status{
  margin-top:8px;
  font-size:13px;
  opacity:.85;
  text-align:center;
}
input{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:none;
  background:#111;
  color:#0f0;
  font-size:12px;
}
</style>
</head>

<body>

<video class="bg" autoplay muted loop playsinline>
  <source src="https://dlngrofficial.github.io/dlngrchat2/pink-puff-clouds.1920x1080.mp4">
</video>
<div class="overlay"></div>

<div class="card">
  <h3 align="center">üåç Global Screen Share</h3>

  <button onclick="startShare()">Start Sharing (Host)</button>
  <button onclick="stopShare()">Stop Sharing</button>
  <button onclick="reconnect()">Reconnect</button>

  <div class="status" id="status">Waiting for host‚Ä¶</div>

  <input id="roomInput" readonly>

  <video id="screen" autoplay playsinline muted></video>
</div>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Global Screen Share</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:black;
  color:white;
  overflow:hidden;
}
video.bg{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  z-index:-2;
}
.overlay{
  position:fixed;
  inset:0;
  background:rgba(5,5,15,.65);
  z-index:-1;
}
.card{
  max-width:420px;
  margin:auto;
  margin-top:8vh;
  background:rgba(255,255,255,.06);
  backdrop-filter:blur(14px);
  padding:20px;
  border-radius:16px;
  border:1px solid rgba(236,72,153,.3);
}
button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  background:linear-gradient(135deg,#ec4899,#6366f1);
  color:white;
  font-size:14px;
  cursor:pointer;
}
video#screen{
  width:100%;
  margin-top:12px;
  border-radius:12px;
  background:black;
}
.status{
  margin-top:8px;
  font-size:13px;
  opacity:.85;
  text-align:center;
}
input{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:none;
  background:#111;
  color:#0f0;
  font-size:12px;
}
</style>
</head>

<body>

<video class="bg" autoplay muted loop playsinline>
  <source src="https://dlngrofficial.github.io/dlngrchat2/pink-puff-clouds.1920x1080.mp4">
</video>
<div class="overlay"></div>

<div class="card">
  <h3 align="center">üåç Global Screen Share</h3>

  <button onclick="startShare()">Start Sharing (Host)</button>
  <button onclick="stopShare()">Stop Sharing</button>
  <button onclick="reconnect()">Reconnect</button>

  <div class="status" id="status">Waiting for host‚Ä¶</div>

  <input id="roomInput" readonly>

  <video id="screen" autoplay playsinline muted></video>
</div>

<script>
/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyCTBijtaD2itFaHPYYAnFm8XdzQjC-r9EU",
  authDomain: "screenshare-5ce9d.firebaseapp.com",
  databaseURL: "https://screenshare-5ce9d-default-rtdb.firebaseio.com",
  projectId: "screenshare-5ce9d"
});
let pendingIce = [];
/* ---------- ROOM ---------- */
let isHost = false;
const room = location.hash.substring(1) || Math.random().toString(36).slice(2);
location.hash = room;

document.getElementById("roomInput").value = location.href;

const statusEl = document.getElementById("status");
const video = document.getElementById("screen");
const db = firebase.database().ref("rooms/" + room);

let pc;

/* ---------- PEER CONNECTION ---------- */
function createPC() {
  pc = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" },
      { urls: "stun:stun1.l.google.com:19302" }
    ]
  });

pc.ontrack = e => {
  video.srcObject = e.streams[0];
  video.muted = true;
  video.play().then(() => {
    statusEl.innerText = "üî¥ Live";
  }).catch(err => {
    console.log('Autoplay blocked:', err);
    statusEl.innerText = "Autoplay blocked ‚Äì click video to play";
    video.style.cursor = 'pointer';  // Visual hint that it's clickable
    video.onclick = () => {
      video.play().then(() => {
        statusEl.innerText = "üî¥ Live";
        video.style.cursor = 'default';
        video.onclick = null;  // Remove click handler after playing
      }).catch(playErr => {
        console.error('Manual play failed:', playErr);
        statusEl.innerText = "Playback failed ‚Äì check permissions";
      });
    };
  });
};

  pc.onicecandidate = e => {
    if (e.candidate) {
      db.child(isHost ? "hostIce" : "viewerIce")
        .push(e.candidate.toJSON());
    }
  };
}

/* ---------- ICE LISTENERS ---------- */
function addIceListeners() {
  db.child("hostIce").off();
  db.child("viewerIce").off();

db.child("hostIce").on("child_added", snap => {
  if (!isHost && snap.val()) {
    if (pc.remoteDescription) {
      pc.addIceCandidate(new RTCIceCandidate(snap.val()))
        .catch(console.error);
    } else {
      pendingIce.push(snap.val());
    }
  }
});


  db.child("viewerIce").on("child_added", snap => {
    if (isHost && snap.val()) {
      pc.addIceCandidate(new RTCIceCandidate(snap.val()))
        .catch(console.error);
    }
  });
}

/* ---------- INIT ---------- */
createPC();
addIceListeners();

/* ---------- SIGNALING ---------- */
db.child("offer").on("value", async snap => {
  if (!snap.val() || pc.currentRemoteDescription) return;

  statusEl.innerText = "Connecting‚Ä¶";
  await pc.setRemoteDescription(snap.val());

  // üî• FLUSH ICE HERE
  pendingIce.forEach(c =>
    pc.addIceCandidate(new RTCIceCandidate(c)).catch(console.error)
  );
  pendingIce = [];

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  db.child("answer").set(answer);
});



db.child("answer").on("value", snap => {
  if (snap.val() && !pc.currentRemoteDescription) {
    pc.setRemoteDescription(snap.val());
  }
});

/* ---------- START SHARING ---------- */
async function startShare() {
  isHost = true;

  pc.close();
 await db.child("offer").remove();
await db.child("answer").remove();
await db.child("hostIce").remove();
await db.child("viewerIce").remove();

  await db.child("hostIce").remove();
await db.child("viewerIce").remove();

  createPC();
  addIceListeners();

  const stream = await navigator.mediaDevices.getDisplayMedia({
    video: true,
    audio: false
  });

  stream.getTracks().forEach(track => pc.addTrack(track, stream));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  db.child("offer").set(offer);

  statusEl.innerText = "üî¥ Sharing screen";
}

/* ---------- STOP SHARING ---------- */
function stopShare() {
  pc.getSenders().forEach(s => s.track && s.track.stop());
  statusEl.innerText = "Stopped sharing";
}


/* ---------- RECONNECT ---------- */
function reconnect() {
  isHost = false;
  pc.close();

  createPC();
  addIceListeners();

  statusEl.innerText = "Waiting for host‚Ä¶";
}
</script>

</body>
</html>


